{% extends 'base.html' %}
{% load static %}

{% block title %}{{ chantier.name_chantier }} - BTP Platform{% endblock %}

{% block content %}
<div class="detail-header">
    <div>
        <h1 class="detail-title">{{ chantier.name_chantier|default:"Non d√©fini" }}</h1>
        <div class="detail-meta">
            <span class="badge badge--default">{{ status_badge }}</span>
        </div>
    </div>
    <a href="{% url 'chantiers' %}" class="btn btn--secondary">
        <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Retour
    </a>
</div>

<div class="tabs">
    <button class="tab tab--active" data-tab="general" type="button">
        <span class="tab__icon">üìå</span>
        Informations g√©n√©rales
    </button>
    <button class="tab" data-tab="location" type="button">
        <span class="tab__icon">üè†</span>
        Localisation
    </button>
    <button class="tab" data-tab="team" type="button">
        <span class="tab__icon">üë•</span>
        √âquipe & Planning
    </button>
    <button class="tab" data-tab="documents" type="button">
        <span class="tab__icon">üìÑ</span>
        D√©tails & Documents
    </button>
</div>

<!-- Tab 1: Informations g√©n√©rales -->
<div id="tab-general" class="tab-content tab-content--active">
    <div class="detail-two-columns">
        <div class="detail-field">
            <div class="detail-field__label">Nom du chantier</div>
            <div class="detail-field__value">{{ chantier.name_chantier|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Type de client final</div>
            <div class="detail-field__value">{{ chantier.client_final_type|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Types de travaux</div>
            <div class="detail-field__value">
                {% if chantier.travaux_type %}
                    {% if chantier.travaux_type|length > 0 %}
                        <ul class="detail-list detail-list--stacked">
                            {% for travail in chantier.travaux_type %}
                                <li>{{ travail }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <span class="detail-field__value--empty">-</span>
                    {% endif %}
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Statut du chantier</div>
            <div class="detail-field__value">
                {% if chantier.avancement_statut %}
                    {% if chantier.avancement_statut|length > 0 %}
                        <ul class="detail-list detail-list--stacked">
                            {% for statut in chantier.avancement_statut %}
                                <li>{{ statut }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <span class="detail-field__value--empty">-</span>
                    {% endif %}
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Prochaine √©tape</div>
            <div class="detail-field__value">
                {% if chantier.cr_next_step %}
                    {% if chantier.cr_next_step|length > 0 %}
                        <ul class="detail-list detail-list--stacked">
                            {% for step in chantier.cr_next_step %}
                                <li>{{ step }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <span class="detail-field__value--empty">-</span>
                    {% endif %}
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Avancement du chantier</div>
            <div class="detail-field__value">{{ chantier.avancement_chantier }}%</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Devis HT (‚Ç¨)</div>
            <div class="detail-field__value">{% if chantier.devis_ht %}{{ chantier.devis_ht|floatformat:2 }} ‚Ç¨{% else %}-{% endif %}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Co√ªt total (‚Ç¨)</div>
            <div class="detail-field__value">{% if chantier.cout_total %}{{ chantier.cout_total|floatformat:2 }} ‚Ç¨{% else %}-{% endif %}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Chef de chantier</div>
            <div class="detail-field__value">{{ chantier.chef_chantier.full_name|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Nombre d'heures</div>
            <div class="detail-field__value">{{ chantier.nbr_heures|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Nombre de jours</div>
            <div class="detail-field__value">{{ chantier.nombre_de_jours_chantier|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">T√©l√©phone de contact</div>
            <div class="detail-field__value">{{ chantier.telephone_contact|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Date de d√©but</div>
            <div class="detail-field__value">{% if chantier.date_debut_chantier %}{{ chantier.date_debut_chantier|date:"d/m/Y" }}{% else %}-{% endif %}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Date de fin pr√©vue</div>
            <div class="detail-field__value">{% if chantier.date_fin_prevue_chantier %}{{ chantier.date_fin_prevue_chantier|date:"d/m/Y" }}{% else %}-{% endif %}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Date RDV technique</div>
            <div class="detail-field__value">{% if chantier.date_rdv_technique %}{{ chantier.date_rdv_technique|date:"d/m/Y" }}{% else %}-{% endif %}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Remarques g√©n√©rales</div>
            <div class="detail-field__value">
                {% if chantier.contact and chantier.contact != "Si besoin pendant le chantier..." %}
                    {{ chantier.contact }}
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Date de cr√©ation</div>
            <div class="detail-field__value">{{ chantier.created_at|date:"d/m/Y √† H:i" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Derni√®re modification</div>
            <div class="detail-field__value">{{ chantier.updated_at|date:"d/m/Y √† H:i" }}</div>
        </div>
    </div>
</div>

<!-- Tab 2: Localisation -->
<div id="tab-location" class="tab-content">
    <div class="detail-two-columns">
        <div class="detail-field">
            <div class="detail-field__label">Adresse du chantier</div>
            <div class="detail-field__value">{{ chantier.adresse_chantier|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Code postal et ville</div>
            <div class="detail-field__value">{{ chantier.cp_ville_chantier|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Latitude</div>
            <div class="detail-field__value">
                {% if chantier.latitude %}
                    {{ chantier.latitude }}
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Longitude</div>
            <div class="detail-field__value">
                {% if chantier.longitude %}
                    {{ chantier.longitude }}
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if chantier.latitude and chantier.longitude %}
    <div class="location-card">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 8px; color: var(--muted);">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <div style="font-size: 13px; color: var(--muted);">Int√©gration avec une API de cartographie requise</div>
    </div>
    {% endif %}
</div>

<!-- Tab 3: √âquipe & Planning -->
<div id="tab-team" class="tab-content">
    <div class="detail-section">
        <h3 class="detail-section__title">√âquipe assign√©e</h3>
        {% if assigned_employees %}
            <ul class="detail-list detail-list--stacked">
                {% for employee in assigned_employees %}
                    <li>{{ employee.full_name }} ({{ employee.user_type }})</li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: var(--muted); font-style: italic;">Aucun employ√© assign√© pour le moment</p>
        {% endif %}
    </div>
    
    <!-- Progress and VA Cards Row -->
    <div class="detail-section">
        <div class="ep-row ep-row--cards">
            <!-- Card 1: Avancement du chantier -->
            <div class="ep-card ep-card--progress">
                <h3 class="ep-card__title">Avancement du chantier</h3>

                {% if not progress.has_hours %}
                    <p class="ep-card__empty">Aucune heure planifi√©e d√©finie pour ce chantier.</p>
                {% else %}
                    <p class="ep-card__summary">
                        Vous avez r√©alis√©
                        <strong>{{ progress.spent|floatformat:0 }}h</strong>
                        ({{ progress.percent|floatformat:0 }}%)
                        pour
                        <strong>{{ progress.planned|floatformat:0 }}h</strong>
                        estim√©es.
                    </p>

                    <div class="ep-progress-bar">
                        {% if progress.green_width > 0 %}
                            <div
                                class="ep-progress-bar__segment ep-progress-bar__segment--green"
                                style="width: {{ progress.green_width }}%;"
                            ></div>
                        {% endif %}
                        {% if progress.grey_width > 0 %}
                            <div
                                class="ep-progress-bar__segment ep-progress-bar__segment--grey"
                                style="width: {{ progress.grey_width }}%;"
                            ></div>
                        {% endif %}
                        {% if progress.red_width > 0 %}
                            <div
                                class="ep-progress-bar__segment ep-progress-bar__segment--red"
                                style="width: {{ progress.red_width }}%;"
                            ></div>
                        {% endif %}
                    </div>

                    <div class="ep-progress-legend">
                        {% if progress.spent < progress.planned %}
                            <div class="ep-legend-item">
                                <span class="ep-dot ep-dot--green"></span>
                                R√©alis√© : {{ progress.spent|floatformat:0 }}h
                            </div>
                            <div class="ep-legend-item">
                                <span class="ep-dot ep-dot--grey"></span>
                                Restant : {{ progress.remaining|floatformat:0 }}h
                            </div>
                        {% elif progress.spent == progress.planned %}
                            <div class="ep-legend-item">
                                <span class="ep-dot ep-dot--green"></span>
                                R√©alis√© : {{ progress.spent|floatformat:0 }}h
                            </div>
                        {% else %}
                            <div class="ep-legend-item">
                                <span class="ep-dot ep-dot--green"></span>
                                R√©alis√© : {{ progress.planned|floatformat:0 }}h
                            </div>
                            <div class="ep-legend-item">
                                <span class="ep-dot ep-dot--red"></span>
                                Exc√©dent r√©alis√© : {{ progress.excess|floatformat:0 }}h
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Card 2: Valeur ajout√©e -->
            <div class="ep-card ep-card--va {% if va_context.va_status == 'good' %}ep-card--va-good{% elif va_context.va_status == 'bad' %}ep-card--va-bad{% endif %}">
                <h3 class="ep-card__title">Valeur ajout√©e du chantier</h3>

                {% if va_context.va_status == 'unknown' %}
                    <p class="ep-card__empty">
                        Aucune donn√©e de devis pour calculer la VA.
                    </p>
                {% else %}
                    <div class="ep-va-main">
                        <span class="ep-va-emoji">
                            {% if va_context.va_status == 'good' %}
                                üòÄ
                            {% elif va_context.va_status == 'bad' %}
                                üòü
                            {% else %}
                                üòê
                            {% endif %}
                        </span>

                        <div class="ep-va-values">
                            <div class="ep-va-line">
                                <span class="ep-va-amount">
                                    {{ va_context.va_euros|floatformat:2 }} ‚Ç¨
                                </span>
                                {% if va_context.va_percent is not None %}
                                    <span class="ep-va-percent">
                                        ({{ va_context.va_percent|floatformat:0 }} %)
                                    </span>
                                {% endif %}
                            </div>
                            <div class="ep-va-sub">
                                VA = Devis HT ‚Äì Co√ªt r√©el
                            </div>
                        </div>
                    </div>

                    <div class="ep-va-footer">
                        Devis HT : {{ va_context.devis|floatformat:2 }} ‚Ç¨ ‚Äì
                        Co√ªt : {{ chantier.cost_spent_on_project|floatformat:2 }} ‚Ç¨
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Planning List Table -->
    <div class="detail-section">
        <h3 class="ep-section-title">Planning</h3>
        
        {% if all_planning_data %}
        <table class="planning-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Employ√©</th>
                    <th>Heure de d√©but</th>
                    <th>Heure de fin</th>
                    <th>Dur√©e</th>
                    <th>Co√ªt</th>
                </tr>
            </thead>
            <tbody>
                {% for slot in all_planning_data %}
                <tr>
                    <td>{{ slot.date|date:"d/m/Y" }}</td>
                    <td>{{ slot.user }}</td>
                    <td>{{ slot.start_hour }}</td>
                    <td>{{ slot.end_hour }}</td>
                    <td>{{ slot.hours|floatformat:2 }}h</td>
                    <td>{{ slot.cost|floatformat:2 }} ‚Ç¨</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: var(--muted); font-style: italic; margin-top: 12px;">Aucun planning pour ce chantier</p>
        {% endif %}
    </div>
</div>

<!-- Tab 4: D√©tails & Documents -->
<div id="tab-documents" class="tab-content">
    <div class="detail-two-columns">
        <div class="detail-field">
            <div class="detail-field__label">Ann√©e / P√©riode de construction</div>
            <div class="detail-field__value">{{ chantier.annee_periode_construction|default:"-" }}</div>
        </div>
        
        <div class="detail-field">
            <div class="detail-field__label">Brief URL</div>
            <div class="detail-field__value">
                {% if chantier.brief_url %}
                    <a href="{{ chantier.brief_url }}" target="_blank" class="link">{{ chantier.brief_url }}</a>
                {% else %}
                    <span class="detail-field__value--empty">-</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="detail-section">
        <h3 class="detail-section__title">Liens Google Drive</h3>
        {% if chantier.gdrive_urls %}
            {% if chantier.gdrive_urls|length > 0 %}
                <ul class="detail-list detail-list--stacked">
                    {% for url in chantier.gdrive_urls %}
                        <li>
                            <a href="{{ url }}" target="_blank" class="link">{{ url }}</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: var(--muted); font-style: italic;">Aucun lien Google Drive</p>
            {% endif %}
        {% else %}
            <p style="color: var(--muted); font-style: italic;">Aucun lien Google Drive</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    function switchTab(tabName) {
        // Hide all tabs and contents
        const allTabs = document.querySelectorAll('.tab');
        const allContents = document.querySelectorAll('.tab-content');
        
        allTabs.forEach(tab => {
            tab.classList.remove('tab--active');
        });
        
        allContents.forEach(content => {
            content.classList.remove('tab-content--active');
        });
        
        // Show selected tab and content
        const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        const selectedContent = document.getElementById(`tab-${tabName}`);
        
        if (selectedTab) {
            selectedTab.classList.add('tab--active');
        }
        
        if (selectedContent) {
            selectedContent.classList.add('tab-content--active');
        }
    }
    
    // Make function globally available
    window.switchTab = switchTab;
    
    // Add event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab');
        tabButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const tabName = this.getAttribute('data-tab');
                if (tabName) {
                    switchTab(tabName);
                }
            });
        });
    });
})();
</script>
{% endblock %}
